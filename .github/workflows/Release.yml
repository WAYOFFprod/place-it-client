name: Prepare Release Branch

on:
  push:
    branches:
      - 'release/**' # Trigger on release/1.0.0, release/v2.3.0, etc.

jobs:
  bump-version:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Required to push commits back
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }} # Checkout the branch, not a detached HEAD

      - name: Extract version from branch name
        id: extract_version
        run: |
          # Removes 'refs/heads/release/' or just 'release/'
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          VERSION=${BRANCH_NAME#release/}
          # Clean 'v' prefix if present (v1.0.0 -> 1.0.0) so package.json is valid
          VERSION=${VERSION#v}
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Configure Git
        run: |
          git config user.name "github-actions-bot"
          git config user.email "github-actions-bot@github.com"

      - name: Update package.json version
        run: |
          # Updates package.json and package-lock.json without creating a git tag
          npm version $VERSION --no-git-tag-version

      - name: Commit and Push
        run: |
          # Check if there are changes to commit
          if [[ -n $(git status -s) ]]; then
            git add package.json package-lock.json
            # [skip ci] prevents this commit from triggering the workflow again
            git commit -m "chore(release): bump version to $VERSION [skip ci]"
            git push
          else
            echo "Version is already up to date."
          fi
